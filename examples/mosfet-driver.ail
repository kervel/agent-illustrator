// Complete Low-Side MOSFET Driver with Gate Buffer
// Demonstrates: Complex templates, multiple voltage domains, realistic circuit
//
// Circuit topology:
// - 3.3V GPIO drives NPN buffer via base resistor
// - NPN pulls MOSFET gate low when GPIO is HIGH (inverting driver)
// - 5V pull-up ensures gate voltage for proper MOSFET turn-on
// - 12V powers the motor load with flyback protection
// - Status LED shows when gate drive signal is active
//
// Note: Uses `--` (undirected) connections for schematic style

// === COMPONENT TEMPLATES ===

// Resistor template - IEC style (stroke-only rectangle)
template "resistor" (value: "R") {
    rect body [width: 40, height: 16, fill: none, stroke: foreground-1, stroke_width: 2, label: value]

    rect left_lead [width: 10, height: 2, fill: foreground-1, stroke: none]
    rect right_lead [width: 10, height: 2, fill: foreground-1, stroke: none]
    constrain left_lead.right = body.left
    constrain left_lead.center_y = body.center_y
    constrain right_lead.left = body.right
    constrain right_lead.center_y = body.center_y

    anchor left_conn [position: left_lead.left, direction: left]
    anchor right_conn [position: right_lead.right, direction: right]
}

// N-Channel Enhancement MOSFET template (IEEE 315 style)
template "nmos" {
    circle body [size: 60, fill: none, stroke: foreground-1, stroke_width: 2]

    // Gate bar (vertical, left of center)
    rect gate_bar [width: 2, height: 30, fill: foreground-1, stroke: none]
    constrain gate_bar.center_x = body.center_x - 6
    constrain gate_bar.center_y = body.center_y

    // Channel: three short vertical segments (broken = enhancement mode)
    rect chan_top [width: 2, height: 8, fill: foreground-1, stroke: none]
    rect chan_mid [width: 2, height: 8, fill: foreground-1, stroke: none]
    rect chan_bot [width: 2, height: 8, fill: foreground-1, stroke: none]
    constrain chan_top.center_x = body.center_x + 2
    constrain chan_mid.center_x = body.center_x + 2
    constrain chan_bot.center_x = body.center_x + 2
    constrain chan_top.top = gate_bar.top
    constrain chan_mid.center_y = body.center_y
    constrain chan_bot.bottom = gate_bar.bottom

    // Gate lead (horizontal, from circle edge to gate bar)
    rect gate_lead [width: 24, height: 2, fill: foreground-1, stroke: none]
    constrain gate_lead.right = gate_bar.left
    constrain gate_lead.center_y = body.center_y

    // Three horizontal stubs from channel segments going right
    rect drain_stub [width: 14, height: 2, fill: foreground-1, stroke: none]
    constrain drain_stub.left = chan_top.right
    constrain drain_stub.center_y = chan_top.center_y

    rect mid_stub [width: 14, height: 2, fill: foreground-1, stroke: none]
    constrain mid_stub.left = chan_mid.right
    constrain mid_stub.center_y = chan_mid.center_y

    rect source_stub [width: 14, height: 2, fill: foreground-1, stroke: none]
    constrain source_stub.left = chan_bot.right
    constrain source_stub.center_y = chan_bot.center_y

    // Drain lead (vertical, going up from drain stub through circle)
    rect drain_lead [width: 2, height: 20, fill: foreground-1, stroke: none]
    constrain drain_lead.center_x = drain_stub.right
    constrain drain_lead.bottom = drain_stub.center_y + 1

    // Source lead (vertical, going down from source stub through circle)
    // Also carries the mid stub connection (body-source short)
    rect source_lead [width: 2, height: 20, fill: foreground-1, stroke: none]
    constrain source_lead.center_x = source_stub.right
    constrain source_lead.top = source_stub.center_y - 1

    // Body-source short: vertical from mid stub level down to source stub level
    // At the same x as source_lead (source_stub.right)
    path body_source [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex a [x: 0, y: 0]
        line_to b [x: 0, y: 11]
    }
    constrain body_source.center_x = source_stub.right
    constrain body_source.top = mid_stub.center_y

    // Arrow pointing LEFT toward gate (N-channel indicator, on mid stub)
    path arrow [fill: foreground-1, stroke: none] {
        vertex tip [x: 0, y: 4]
        line_to upper [x: 6, y: 0]
        line_to lower [x: 6, y: 8]
        close
    }
    constrain arrow.right = chan_mid.left + 6
    constrain arrow.center_y = body.center_y

    // Dot at body-source junction
    circle dot [size: 5, fill: foreground-1, stroke: none]
    constrain dot.center_x = source_stub.right
    constrain dot.center_y = source_stub.center_y

    // Labels
    text "G" g_label [font_size: 12, fill: foreground-1]
    text "D" d_label [font_size: 12, fill: foreground-1]
    text "S" s_label [font_size: 12, fill: foreground-1]
    constrain g_label.right = gate_lead.left - 6
    constrain g_label.center_y = gate_lead.center_y
    constrain d_label.center_x = drain_lead.center_x
    constrain d_label.bottom = drain_lead.top - 4
    constrain s_label.center_x = source_lead.center_x
    constrain s_label.top = source_lead.bottom + 4

    anchor gate [position: gate_lead.left, direction: left]
    anchor drain [position: drain_lead.top, direction: up]
    anchor source [position: source_lead.bottom, direction: down]
}

// NPN Bipolar Junction Transistor template (IEEE 315 style)
template "npn" {
    circle body [size: 50, fill: none, stroke: foreground-1, stroke_width: 2]

    // Base bar (vertical line inside circle, left of center)
    rect base_bar [width: 2, height: 20, fill: foreground-1, stroke: none]
    constrain base_bar.center_x = body.center_x - 8
    constrain base_bar.center_y = body.center_y

    // Base lead (horizontal, from circle edge to base bar)
    rect base_lead [width: 17, height: 2, fill: foreground-1, stroke: none]
    constrain base_lead.right = base_bar.left
    constrain base_lead.center_y = body.center_y

    // Collector diagonal: from base bar (upper) going up-right
    // Path goes from (0, 14) to (17, 0) — bbox: left=0, top=0, right=17, bottom=14
    path collector_diag [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex a [x: 0, y: 14]
        line_to b [x: 17, y: 0]
    }
    constrain collector_diag.left = base_bar.right
    constrain collector_diag.bottom = body.center_y - 6

    // Collector lead: vertical, connected to diagonal endpoint via constraints
    rect collector_lead [width: 2, height: 18, fill: foreground-1, stroke: none]
    constrain collector_lead.center_x = collector_diag.right
    constrain collector_lead.bottom = collector_diag.top

    // Emitter diagonal: from base bar (lower) going down-right
    // Path goes from (0, 0) to (17, 14) — bbox: left=0, top=0, right=17, bottom=14
    path emitter_diag [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex a [x: 0, y: 0]
        line_to b [x: 17, y: 14]
    }
    constrain emitter_diag.left = base_bar.right
    constrain emitter_diag.top = body.center_y + 6

    // Emitter lead: vertical, connected to diagonal endpoint via constraints
    rect emitter_lead [width: 2, height: 18, fill: foreground-1, stroke: none]
    constrain emitter_lead.center_x = emitter_diag.right
    constrain emitter_lead.top = emitter_diag.bottom

    // Emitter arrow (pointing outward, at diagonal tip)
    path emitter_arrow [fill: foreground-1, stroke: none] {
        vertex a [x: 0, y: 0]
        line_to b [x: -3, y: -7]
        line_to c [x: -8, y: -2]
        close
    }
    constrain emitter_arrow.right = emitter_diag.right + 1
    constrain emitter_arrow.bottom = emitter_diag.bottom + 1

    // Labels
    text "B" b_label [font_size: 11, fill: foreground-1]
    text "C" c_label [font_size: 11, fill: foreground-1]
    text "E" e_label [font_size: 11, fill: foreground-1]
    constrain b_label.right = base_lead.left - 4
    constrain b_label.center_y = base_lead.center_y
    constrain c_label.center_x = collector_lead.center_x
    constrain c_label.bottom = collector_lead.top - 3
    constrain e_label.center_x = emitter_lead.center_x
    constrain e_label.top = emitter_lead.bottom + 3

    anchor base [position: base_lead.left, direction: left]
    anchor collector [position: collector_lead.top, direction: up]
    anchor emitter [position: emitter_lead.bottom, direction: down]
}

// LED template - schematic style
template "led" (color: accent-1) {
    path triangle [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex tl [x: 0, y: 0]
        line_to tr [x: 20, y: 0]
        line_to tip [x: 10, y: 18]
        close
    }

    rect cathode_bar [width: 24, height: 2, fill: foreground-1, stroke: none]
    constrain cathode_bar.center_x = triangle.center_x
    constrain cathode_bar.top = triangle.bottom + 3

    rect anode_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain anode_lead.center_x = triangle.center_x
    constrain anode_lead.bottom = triangle.top

    rect cathode_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain cathode_lead.center_x = cathode_bar.center_x
    constrain cathode_lead.top = cathode_bar.bottom

    // Emission arrows
    path arrow1 [fill: none, stroke: color, stroke_width: 1.5] {
        vertex a [x: 0, y: 8]
        line_to b [x: 10, y: 0]
    }
    path head1 [fill: color, stroke: none] {
        vertex t [x: 10, y: 0]
        line_to bl [x: 6, y: 0]
        line_to br [x: 10, y: 4]
        close
    }
    constrain arrow1.left = triangle.right + 4
    constrain arrow1.top = triangle.top + 2
    constrain head1.left = arrow1.left + 6
    constrain head1.top = arrow1.top

    path arrow2 [fill: none, stroke: color, stroke_width: 1.5] {
        vertex a [x: 0, y: 8]
        line_to b [x: 10, y: 0]
    }
    path head2 [fill: color, stroke: none] {
        vertex t [x: 10, y: 0]
        line_to bl [x: 6, y: 0]
        line_to br [x: 10, y: 4]
        close
    }
    constrain arrow2.left = triangle.right + 4
    constrain arrow2.top = arrow1.bottom + 2
    constrain head2.left = arrow2.left + 6
    constrain head2.top = arrow2.top

    anchor anode [position: anode_lead.top, direction: up]
    anchor cathode [position: cathode_lead.bottom, direction: down]
}

// Diode template (for flyback protection)
template "diode" {
    path triangle [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex tl [x: 0, y: 0]
        line_to tr [x: 16, y: 0]
        line_to tip [x: 8, y: 14]
        close
    }

    rect cathode_bar [width: 20, height: 2, fill: foreground-1, stroke: none]
    constrain cathode_bar.center_x = triangle.center_x
    constrain cathode_bar.top = triangle.bottom + 2

    rect anode_lead [width: 2, height: 12, fill: foreground-1, stroke: none]
    constrain anode_lead.center_x = triangle.center_x
    constrain anode_lead.bottom = triangle.top

    rect cathode_lead [width: 2, height: 12, fill: foreground-1, stroke: none]
    constrain cathode_lead.center_x = cathode_bar.center_x
    constrain cathode_lead.top = cathode_bar.bottom

    anchor anode [position: anode_lead.top, direction: up]
    anchor cathode [position: cathode_lead.bottom, direction: down]
}

// DC Motor template
template "motor" {
    circle body [size: 50, fill: none, stroke: foreground-1, stroke_width: 2]

    text "M" motor_label [font_size: 20, fill: foreground-1]
    constrain motor_label.center_x = body.center_x
    constrain motor_label.center_y = body.center_y

    rect top_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain top_lead.center_x = body.center_x
    constrain top_lead.top = body.top - 15

    rect bottom_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain bottom_lead.center_x = body.center_x
    constrain bottom_lead.bottom = body.bottom + 15

    anchor positive [position: top_lead.top, direction: up]
    anchor negative [position: bottom_lead.bottom, direction: down]
}

// Power rail template
template "power_rail" (voltage: "+V") {
    rect rail [width: 60, height: 4, fill: secondary-dark, stroke: none, label: voltage]
    anchor conn [position: rail.bottom + 4, direction: down]
}

// Ground symbol template
template "ground_sym" {
    rect line1 [width: 40, height: 3, fill: foreground-2, stroke: none]
    rect line2 [width: 26, height: 3, fill: foreground-2, stroke: none]
    rect line3 [width: 12, height: 3, fill: foreground-2, stroke: none]
    constrain line2.top = line1.bottom + 4
    constrain line3.top = line2.bottom + 4
    constrain line2.center_x = line1.center_x
    constrain line3.center_x = line1.center_x
    anchor conn [position: line1.top - 4, direction: up]
}

// GPIO Pin template
template "gpio_pin" (name: "GPIO") {
    rect body [width: 50, height: 20, fill: accent-2, stroke: accent-1, stroke_width: 1.5, label: name]
    anchor output [position: body.right + 4, direction: right]
}

// Junction dot (for wire connections)
template "junction" {
    circle dot [size: 8, fill: foreground-1, stroke: none]
    anchor conn [position: dot.center_x, direction: down]
}


// === CIRCUIT INSTANTIATION ===

// Power rails
power_rail vcc_12v [voltage: "+12V"]
power_rail vcc_5v [voltage: "+5V"]
power_rail vcc_3v3 [voltage: "+3.3V"]

// Load section (12V domain)
motor load_motor
diode d_flyback [rotation: 180]  // Flyback diode (reversed)
nmos q_main

// Gate driver section (5V domain)
resistor r_pullup [value: "10k", rotation: 90]
resistor r_gate [value: "100Ω"]
resistor r_pulldown [value: "100k", rotation: 90]
npn q_driver

// Control section (3.3V domain)
gpio_pin gpio [name: "GPIO_4"]
resistor r_base [value: "1kΩ"]
resistor r_led [value: "330Ω", rotation: 90]
led status_led [color: green]

// Ground symbols
ground_sym gnd_main
ground_sym gnd_driver
ground_sym gnd_led


// === LAYOUT ===

// 12V power rail and load - right side, top
constrain vcc_12v.center_x = 350
constrain vcc_12v.top = 20

constrain load_motor.positive_x = vcc_12v.conn_x
constrain load_motor.top = vcc_12v.bottom + 30

constrain d_flyback.center_x = load_motor.center_x + 60
constrain d_flyback.center_y = load_motor.center_y

// MOSFET below motor - drain aligns with motor negative terminal
constrain q_main.drain_x = load_motor.negative_x
constrain q_main.top = load_motor.bottom + 40

constrain gnd_main.conn_x = q_main.source_x
constrain gnd_main.top = q_main.bottom + 30


// 5V gate drive section - middle
constrain vcc_5v.center_x = 180
constrain vcc_5v.top = 20

constrain r_pullup.center_x = vcc_5v.center_x
constrain r_pullup.top = vcc_5v.bottom + 30

constrain r_gate.center_y = r_pullup.bottom + 30
constrain r_gate.left = r_pullup.right + 20

// NPN driver below pullup
constrain q_driver.center_x = vcc_5v.center_x
constrain q_driver.top = r_pullup.bottom + 80

constrain r_pulldown.center_x = r_gate.center_x + 40
constrain r_pulldown.top = r_gate.center_y + 20

constrain gnd_driver.conn_x = q_driver.emitter_x
constrain gnd_driver.top = q_driver.bottom + 30


// 3.3V control section - left side
constrain vcc_3v3.center_x = 30
constrain vcc_3v3.top = 20

constrain gpio.center_x = vcc_3v3.center_x
constrain gpio.top = vcc_3v3.bottom + 60

constrain r_base.left = gpio.right + 15
constrain r_base.center_y = gpio.center_y

constrain r_led.left_conn_x = vcc_3v3.center_x
constrain r_led.top = gpio.bottom + 40

constrain status_led.anode_x = r_led.right_conn_x
constrain status_led.top = r_led.bottom + 30

constrain gnd_led.conn_x = status_led.cathode_x
constrain gnd_led.top = status_led.bottom + 30


// === CONNECTIONS ===

// 12V Load path
vcc_12v.conn -- load_motor.positive [stroke: secondary-dark, stroke_width: 2]
load_motor.negative -- q_main.drain [stroke: secondary-dark, stroke_width: 2]
q_main.source -- gnd_main.conn [stroke: foreground-2, stroke_width: 1.5]

// Flyback diode (across motor)
d_flyback.cathode -- vcc_12v.conn [stroke: secondary-dark, stroke_width: 1.5]
d_flyback.anode -- q_main.drain [stroke: secondary-dark, stroke_width: 1.5]

// 5V Gate drive path
vcc_5v.conn -- r_pullup.left_conn [stroke: accent-1, stroke_width: 2]
r_pullup.right_conn -- r_gate.left_conn [stroke: accent-1, stroke_width: 2]
r_gate.right_conn -- q_main.gate [stroke: accent-1, stroke_width: 2]
r_pullup.right_conn -- q_driver.collector [stroke: accent-1, stroke_width: 1.5]
r_gate.right_conn -- r_pulldown.left_conn [stroke: accent-1, stroke_width: 1.5]
r_pulldown.right_conn -- gnd_driver.conn [stroke: foreground-2, stroke_width: 1.5]
q_driver.emitter -- gnd_driver.conn [stroke: foreground-2, stroke_width: 1.5]

// 3.3V Control path
gpio.output -- r_base.left_conn [stroke: accent-2, stroke_width: 2]
r_base.right_conn -- q_driver.base [stroke: accent-2, stroke_width: 2]

// Status LED path (shows when GPIO is active)
gpio.output -- r_led.left_conn [stroke: accent-2, stroke_width: 1.5]
r_led.right_conn -- status_led.anode [stroke: accent-2, stroke_width: 1.5]
status_led.cathode -- gnd_led.conn [stroke: foreground-2, stroke_width: 1.5]


// === ANNOTATIONS ===

text "12V Load Domain" label_12v [font_size: 11, fill: secondary-dark]
text "5V Gate Drive" label_5v [font_size: 11, fill: accent-1]
text "3.3V Control" label_3v [font_size: 11, fill: accent-2]

constrain label_12v.left = vcc_12v.right + 10
constrain label_12v.center_y = vcc_12v.center_y

constrain label_5v.left = vcc_5v.right + 10
constrain label_5v.center_y = vcc_5v.center_y

constrain label_3v.left = vcc_3v3.right + 10
constrain label_3v.center_y = vcc_3v3.center_y

text "Status" status_label [font_size: 10, fill: green]
constrain status_label.right = status_led.left - 8
constrain status_label.center_y = status_led.center_y

text "Flyback" flyback_label [font_size: 10, fill: foreground-2]
constrain flyback_label.left = d_flyback.right + 5
constrain flyback_label.center_y = d_flyback.center_y
