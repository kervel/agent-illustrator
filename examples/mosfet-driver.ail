// MOSFET Driver with LED Status Indicator
// Demonstrates: Templates, parameterization, semantic anchors, circuit layout
// Voltage domains: 3.3V (GPIO) and 5V (load)
//
// Note: Uses `--` (undirected) connections instead of `->` (arrows)
// because electronic schematics don't typically use arrows on wires.

// === COMPONENT TEMPLATES ===

// T001: Resistor template - IEC style (stroke-only, matches MOSFET style)
template "resistor" (value: "R") {
    rect body [width: 40, height: 16, fill: none, stroke: foreground-1, stroke_width: 2, label: value]

    // Lead extensions for cleaner connections
    rect left_lead [width: 10, height: 2, fill: foreground-1, stroke: none]
    rect right_lead [width: 10, height: 2, fill: foreground-1, stroke: none]
    constrain left_lead.right = body.left
    constrain left_lead.center_y = body.center_y
    constrain right_lead.left = body.right
    constrain right_lead.center_y = body.center_y

    anchor left_conn [position: left_lead.left, direction: left]
    anchor right_conn [position: right_lead.right, direction: right]
}

// T002: N-Channel MOSFET template with proper symbol
// Standard symbol: circle with vertical channel (3 stubs), gate bar, and arrow
template "nmos" {
    // Circle enclosing the transistor
    circle body [size: 60, fill: none, stroke: foreground-1, stroke_width: 2]

    // Vertical channel (right side, inside circle) - 3 horizontal stubs connect here
    rect channel [width: 2, height: 36, fill: foreground-1, stroke: none]
    constrain channel.center_x = body.center_x + 8
    constrain channel.center_y = body.center_y

    // Gate bar (left of channel, with visible gap)
    rect gate_bar [width: 2, height: 36, fill: foreground-1, stroke: none]
    constrain gate_bar.center_x = body.center_x - 4
    constrain gate_bar.center_y = body.center_y

    // Gate lead extending left out of circle
    rect gate_lead [width: 30, height: 2, fill: foreground-1, stroke: none]
    constrain gate_lead.right = gate_bar.left
    constrain gate_lead.center_y = body.center_y

    // Three horizontal stubs from channel (proper MOSFET symbol)
    // Drain stub (top)
    rect drain_stub [width: 16, height: 2, fill: foreground-1, stroke: none]
    constrain drain_stub.right = channel.left + 1
    constrain drain_stub.center_y = channel.top + 4

    // Middle stub (part of standard symbol)
    rect mid_stub [width: 16, height: 2, fill: foreground-1, stroke: none]
    constrain mid_stub.right = channel.left + 1
    constrain mid_stub.center_y = body.center_y

    // Source stub (bottom)
    rect source_stub [width: 16, height: 2, fill: foreground-1, stroke: none]
    constrain source_stub.right = channel.left + 1
    constrain source_stub.center_y = channel.bottom - 4

    // Drain lead going up from drain_stub, out through circle top
    rect drain_lead [width: 2, height: 24, fill: foreground-1, stroke: none]
    constrain drain_lead.center_x = drain_stub.left + 1
    constrain drain_lead.bottom = drain_stub.center_y + 1

    // Source lead going down from source_stub, out through circle bottom
    rect source_lead [width: 2, height: 24, fill: foreground-1, stroke: none]
    constrain source_lead.center_x = source_stub.left + 1
    constrain source_lead.top = source_stub.center_y - 1

    // Arrow on middle stub pointing right (toward channel) - indicates N-channel
    rect arrow [width: 8, height: 2, fill: foreground-1, stroke: none]
    constrain arrow.right = mid_stub.left
    constrain arrow.center_y = mid_stub.center_y

    // Labels
    text "G" g_label [font_size: 12, fill: foreground-1]
    text "D" d_label [font_size: 12, fill: foreground-1]
    text "S" s_label [font_size: 12, fill: foreground-1]

    constrain g_label.right = gate_lead.left - 6
    constrain g_label.center_y = gate_lead.center_y
    constrain d_label.center_x = drain_lead.center_x
    constrain d_label.bottom = drain_lead.top - 4
    constrain s_label.center_x = source_lead.center_x
    constrain s_label.top = source_lead.bottom + 4

    anchor gate [position: gate_lead.left, direction: left]
    anchor drain [position: drain_lead.top, direction: up]
    anchor source [position: source_lead.bottom, direction: down]
}

// T003: LED template - schematic style (triangle diode with emission arrows)
template "led" (color: accent-1) {
    // Triangle body (diode) pointing down - using path
    path triangle [fill: none, stroke: foreground-1, stroke_width: 2] {
        vertex tl [x: 0, y: 0]
        line_to tr [x: 20, y: 0]
        line_to tip [x: 10, y: 18]
        close
    }

    // Cathode bar below triangle tip
    rect cathode_bar [width: 24, height: 2, fill: foreground-1, stroke: none]
    constrain cathode_bar.center_x = triangle.center_x
    constrain cathode_bar.top = triangle.bottom + 3

    // Anode lead up
    rect anode_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain anode_lead.center_x = triangle.center_x
    constrain anode_lead.bottom = triangle.top

    // Cathode lead down
    rect cathode_lead [width: 2, height: 15, fill: foreground-1, stroke: none]
    constrain cathode_lead.center_x = cathode_bar.center_x
    constrain cathode_lead.top = cathode_bar.bottom

    // Light emission arrows - diagonal pointing up-right with arrowheads
    path arrow1 [fill: none, stroke: color, stroke_width: 1.5] {
        vertex a [x: 0, y: 8]
        line_to b [x: 10, y: 0]
    }
    path head1 [fill: color, stroke: none] {
        vertex t [x: 10, y: 0]
        line_to bl [x: 6, y: 0]
        line_to br [x: 10, y: 4]
        close
    }
    constrain arrow1.left = triangle.right + 4
    constrain arrow1.top = triangle.top + 2
    constrain head1.left = arrow1.left + 6
    constrain head1.top = arrow1.top

    path arrow2 [fill: none, stroke: color, stroke_width: 1.5] {
        vertex a [x: 0, y: 8]
        line_to b [x: 10, y: 0]
    }
    path head2 [fill: color, stroke: none] {
        vertex t [x: 10, y: 0]
        line_to bl [x: 6, y: 0]
        line_to br [x: 10, y: 4]
        close
    }
    constrain arrow2.left = triangle.right + 4
    constrain arrow2.top = arrow1.bottom + 2
    constrain head2.left = arrow2.left + 6
    constrain head2.top = arrow2.top

    anchor anode [position: anode_lead.top, direction: up]
    anchor cathode [position: cathode_lead.bottom, direction: down]
}

// T004: GPIO Pin template - proportional to resistor (40x16)
template "gpio_pin" (name: "GPIO") {
    rect body [width: 50, height: 20, fill: accent-2, stroke: accent-1, stroke_width: 1.5, label: name]
    anchor output [position: body.right + 4, direction: right]
}

// T005: Power rail template
template "power_rail" (voltage: "+5V") {
    // Power symbol: horizontal bar with label
    rect rail [width: 80, height: 4, fill: secondary-dark, stroke: none]
    rect label_bg [width: 50, height: 20, fill: none, stroke: none, label: voltage]
    constrain label_bg.center_x = rail.center_x
    constrain label_bg.bottom = rail.top - 2
    anchor conn [position: rail.bottom + 4, direction: down]
}

// T006: Ground symbol template - three horizontal bars decreasing in width
template "ground_sym" {
    // Use explicit positioning for centering
    rect line1 [width: 40, height: 3, fill: foreground-2, stroke: none]
    rect line2 [width: 26, height: 3, fill: foreground-2, stroke: none]
    rect line3 [width: 12, height: 3, fill: foreground-2, stroke: none]

    // Stack vertically with gaps
    constrain line2.top = line1.bottom + 4
    constrain line3.top = line2.bottom + 4

    // Center all lines
    constrain line2.center_x = line1.center_x
    constrain line3.center_x = line1.center_x

    anchor conn [position: line1.top - 4, direction: up]
}


// === CIRCUIT LAYOUT ===

// Instantiate all components
power_rail vcc [voltage: "+5V"]
resistor r_limit [value: "220Ω"]
led status_led [color: green]
gpio_pin gpio [name: "GPIO_5"]
resistor r_gate [value: "10kΩ"]
nmos q1
resistor r_pulldown [value: "10kΩ"]
ground_sym gnd

// === LAYOUT POSITIONING ===

// Power rail at top center
constrain vcc.center_x = 200
constrain vcc.top = 20

// Load section: resistor and LED below power rail
constrain r_limit.center_x = vcc.center_x
constrain r_limit.top = vcc.bottom + 40

constrain status_led.center_x = vcc.center_x
constrain status_led.top = r_limit.bottom + 30

// MOSFET below LED, aligned
constrain q1.center_x = vcc.center_x
constrain q1.top = status_led.bottom + 40

// GPIO and gate resistor to the left of MOSFET
constrain gpio.right = q1.left - 100
constrain gpio.center_y = q1.center_y

constrain r_gate.left = gpio.right + 20
constrain r_gate.center_y = q1.center_y

// Pulldown resistor below MOSFET
constrain r_pulldown.center_x = q1.center_x
constrain r_pulldown.top = q1.bottom + 40

// Ground below pulldown
constrain gnd.center_x = q1.center_x
constrain gnd.top = r_pulldown.bottom + 30


// === CONNECTIONS (using -- for no arrows) ===

// 5V domain (load path)
vcc.conn -- r_limit.left_conn [stroke: secondary-dark, stroke_width: 2]
r_limit.right_conn -- status_led.anode [stroke: secondary-dark, stroke_width: 2]
status_led.cathode -- q1.drain [stroke: secondary-dark, stroke_width: 2]

// 3.3V domain (gate drive)
gpio.output -- r_gate.left_conn [stroke: accent-1, stroke_width: 2]
r_gate.right_conn -- q1.gate [stroke: accent-1, stroke_width: 2]

// Ground path
q1.source -- r_pulldown.left_conn [stroke: foreground-2, stroke_width: 1.5]
r_pulldown.right_conn -- gnd.conn [stroke: foreground-2, stroke_width: 1.5]


// === ANNOTATIONS ===

text "5V Load" label_5v [font_size: 11, fill: secondary-dark]
text "3.3V Control" label_3v [font_size: 11, fill: accent-1]

constrain label_5v.left = vcc.right + 15
constrain label_5v.center_y = vcc.center_y

constrain label_3v.right = gpio.left - 10
constrain label_3v.center_y = gpio.center_y
