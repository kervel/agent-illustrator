// Railway Topology - Three Level Abstraction
// Uses symbolic colors for brand-agnostic theming
// Uses [role: label] for element labels

col diagram {
    // === MICRO LEVEL ===
    // 2 main tracks (A and B) with crossover connections
    // Track A: a1 -- jA1 -- jA2 -- a2
    // Track B: b1 -- jB1 -- jB2 -- b2
    // Crossovers: jA1 -> jB1 (left), jB2 -> jA2 (right)
    group micro {
        col micro_label [role: label] {
            text "Micro" micro_lbl [font_size: 20, fill: text-1]
            text "Detailed tracks" [font_size: 12, fill: text-2]
        }

        col tracks [gap: 30] {
            // Track A (top)
            row trackA [gap: 80] {
                circle a1 [fill: accent-1, size: 6]
                circle jA1 [fill: accent-1, size: 6]
                circle jA2 [fill: accent-1, size: 6]
                circle a2 [fill: accent-1, size: 6]
            }
            // Track B (bottom)
            row trackB [gap: 80] {
                circle b1 [fill: accent-1, size: 6]
                circle jB1 [fill: accent-1, size: 6]
                circle jB2 [fill: accent-1, size: 6]
                circle b2 [fill: accent-1, size: 6]
            }

            // Offset top junctions for diagonal crossovers:
            // jA1 offset left → diagonal goes down-right to jB1
            // jA2 offset right → diagonal goes down-left from jB2
            constrain jA1.center_x = jB1.center_x
            place jA1 [x: -40]
            constrain jA2.center_x = jB2.center_x
            place jA2 [x: 40]

            // Track A main line
            a1 -- jA1 [stroke: text-1, stroke_width: 2, routing: direct]
            jA1 -- jA2 [stroke: text-1, stroke_width: 2, routing: direct]
            jA2 -- a2 [stroke: text-1, stroke_width: 2, routing: direct]

            // Track B main line
            b1 -- jB1 [stroke: text-1, stroke_width: 2, routing: direct]
            jB1 -- jB2 [stroke: text-1, stroke_width: 2, routing: direct]
            jB2 -- b2 [stroke: text-1, stroke_width: 2, routing: direct]

            // Crossover connections (switches)
            jA1 -- jB1 [stroke: text-1, stroke_width: 2, routing: direct]
            jB2 -- jA2 [stroke: text-1, stroke_width: 2, routing: direct]
        }
    }

    // === MESO LEVEL ===
    // Same track structure as Micro, with dashed ellipses for operational points
    group meso {
        col meso_label [role: label] {
            text "Meso" meso_lbl [font_size: 20, fill: text-1]
            text "OPs + Tracks" [font_size: 12, fill: text-2]
        }

        // Stack: ellipses behind tracks
        stack meso_content {
            // Ellipses positioned over junction areas
            // Left junction area: mjA1 at ~66, mjB1 at ~106 -> center ~86
            // Right junction area: mjA2 at ~232, mjB2 at ~192 -> center ~212
            // Ellipse width 140 so x = center - 70
            ellipse op1 [fill: accent-light, opacity: 0.3, stroke: accent-1, stroke_dasharray: "6,3", width: 140, height: 80, label: "OP 1 (Station)"]
            ellipse op2 [fill: accent-light, opacity: 0.3, stroke: accent-1, stroke_dasharray: "6,3", width: 140, height: 80, label: "OP 2 (Station)"]
            // op1 center should be at ~91, so x=91-70=21
            // op2 center should be at ~220, so x=220-70=150
            place op1 [x: -66]
            place op2 [x: 63]

            // Track structure (same as Micro but grayed)
            col meso_tracks [gap: 30] {
                row mtrackA [gap: 80] {
                    circle ma1 [fill: foreground-3, size: 6]
                    circle mjA1 [fill: foreground-3, size: 6]
                    circle mjA2 [fill: foreground-3, size: 6]
                    circle ma2 [fill: foreground-3, size: 6]
                }
                row mtrackB [gap: 80] {
                    circle mb1 [fill: foreground-3, size: 6]
                    circle mjB1 [fill: foreground-3, size: 6]
                    circle mjB2 [fill: foreground-3, size: 6]
                    circle mb2 [fill: foreground-3, size: 6]
                }

                // Offset junctions (same as Micro)
                constrain mjA1.center_x = mjB1.center_x
                place mjA1 [x: -40]
                constrain mjA2.center_x = mjB2.center_x
                place mjA2 [x: 40]

                // Track lines (grayed)
                ma1 -- mjA1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA1 -- mjA2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA2 -- ma2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mb1 -- mjB1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB1 -- mjB2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB2 -- mb2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA1 -- mjB1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB2 -- mjA2 [stroke: foreground-3, stroke_width: 2, routing: direct]
            }
        }
    }

    // === MACRO LEVEL ===
    group macro {
        // Label using new [role: label] modifier
        col macro_label [role: label] {
            text "Macro" macro_lbl [font_size: 20, fill: text-1]
            text "Nodes & Lines" [font_size: 12, fill: text-2]
        }

        row graph [gap: 100] {
            circle n1 [fill: accent-1, size: 50, label: "OP 1"]
            circle n2 [fill: accent-1, size: 50, label: "OP 2"]
            n1 -- n2 [stroke: accent-1, stroke_width: 3, label: "Section of Line (SoL)", routing: direct]
        }
    }

    // Aggregation arrows with connection label references
    text "Aggregation" agg_label [font_size: 11, fill: foreground-3]
    text "Simplification" simp_label [font_size: 11, fill: foreground-3]
    micro_label -> meso_label [label: agg_label, label_position: right, stroke: foreground-3, routing: direct]
    meso_label -> macro_label [label: simp_label, label_position: right, stroke: foreground-3, routing: direct]

    // Constrain the level labels to same vertical axis
    // Containers for correct arrow routing
    constrain micro_label.center_x = meso_label.center_x
    constrain meso_label.center_x = macro_label.center_x
    // Text elements for visual alignment
    constrain micro_lbl.center_x = meso_lbl.center_x
    constrain meso_lbl.center_x = macro_lbl.center_x
}
