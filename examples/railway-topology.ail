// Railway Topology - Three Level Abstraction
// Uses symbolic colors for brand-agnostic theming
// Uses [role: label] for element labels

col diagram {
    // === MICRO LEVEL ===
    // 2 main tracks (A and B) with crossover connections
    // Track A: a1 -- jA1 -- jA2 -- a2
    // Track B: b1 -- jB1 -- jB2 -- b2
    // Crossovers: jA1 -> jB1 (left), jB2 -> jA2 (right)
    group micro {
        col micro_label [role: label] {
            text "Micro" micro_lbl [font_size: 20, fill: text-1]
            text "Detailed tracks" [font_size: 12, fill: text-2]
        }

        col tracks [gap: 30] {
            // Track A (top)
            row trackA [gap: 80] {
                circle a1 [fill: accent-1, size: 6]
                circle jA1 [fill: accent-1, size: 6]
                circle jA2 [fill: accent-1, size: 6]
                circle a2 [fill: accent-1, size: 6]
            }
            // Track B (bottom)
            row trackB [gap: 80] {
                circle b1 [fill: accent-1, size: 6]
                circle jB1 [fill: accent-1, size: 6]
                circle jB2 [fill: accent-1, size: 6]
                circle b2 [fill: accent-1, size: 6]
            }

            // Preserve B track spacing (jB2 is 160px right of jB1)
            constrain jB2.center_x = jB1.center_x + 160
            // Center the junction pair within the track
            // midpoint of jB1,jB2 should equal midpoint of b1,b2
            // jB1 + 80 = midpoint(b1,b2), so jB1 = midpoint(b1,b2) - 80
            constrain jB1.center_x = midpoint(b1, b2) - 80

            // Offset A junctions for diagonal crossovers:
            // jA1 offset left → diagonal goes down-right to jB1
            // jA2 offset right → diagonal goes down-left from jB2
            constrain jA1.center_x = jB1.center_x - 40
            constrain jA2.center_x = jB2.center_x + 40

            // Track A main line
            a1 -- jA1 [stroke: text-1, stroke_width: 2, routing: direct]
            jA1 -- jA2 [stroke: text-1, stroke_width: 2, routing: direct]
            jA2 -- a2 [stroke: text-1, stroke_width: 2, routing: direct]

            // Track B main line
            b1 -- jB1 [stroke: text-1, stroke_width: 2, routing: direct]
            jB1 -- jB2 [stroke: text-1, stroke_width: 2, routing: direct]
            jB2 -- b2 [stroke: text-1, stroke_width: 2, routing: direct]

            // Crossover connections (switches)
            jA1 -- jB1 [stroke: text-1, stroke_width: 2, routing: direct]
            jB2 -- jA2 [stroke: text-1, stroke_width: 2, routing: direct]
        }
    }

    // === MESO LEVEL ===
    // Same track structure as Micro, with dashed ellipses for operational points
    group meso {
        col meso_label [role: label] {
            text "Meso" meso_lbl [font_size: 20, fill: text-1]
            text "OPs + Tracks" [font_size: 12, fill: text-2]
        }

        // Stack: ellipses behind tracks
        stack meso_content {
            // Ellipses positioned over junction areas using constraints
            ellipse op1 [fill: accent-light, opacity: 0.3, stroke: accent-1, stroke_dasharray: "6,3", width: 140, height: 80, label: "OP 1 (Station)"]
            ellipse op2 [fill: accent-light, opacity: 0.3, stroke: accent-1, stroke_dasharray: "6,3", width: 140, height: 80, label: "OP 2 (Station)"]

            // Track structure (same as Micro but grayed)
            col meso_tracks [gap: 30] {
                row mtrackA [gap: 80] {
                    circle ma1 [fill: foreground-3, size: 6]
                    circle mjA1 [fill: foreground-3, size: 6]
                    circle mjA2 [fill: foreground-3, size: 6]
                    circle ma2 [fill: foreground-3, size: 6]
                }
                row mtrackB [gap: 80] {
                    circle mb1 [fill: foreground-3, size: 6]
                    circle mjB1 [fill: foreground-3, size: 6]
                    circle mjB2 [fill: foreground-3, size: 6]
                    circle mb2 [fill: foreground-3, size: 6]
                }

                // Align meso B junctions to micro B junctions (cross-level alignment)
                constrain mjB1.center_x = jB1.center_x
                constrain mjB2.center_x = jB2.center_x

                // Offset A junctions for diagonal crossovers (same as micro)
                constrain mjA1.center_x = mjB1.center_x - 40
                constrain mjA2.center_x = mjB2.center_x + 40

                // Track lines (grayed)
                ma1 -- mjA1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA1 -- mjA2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA2 -- ma2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mb1 -- mjB1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB1 -- mjB2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB2 -- mb2 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjA1 -- mjB1 [stroke: foreground-3, stroke_width: 2, routing: direct]
                mjB2 -- mjA2 [stroke: foreground-3, stroke_width: 2, routing: direct]
            }

            // Position ellipses over junction areas using constraints
            // op1 centered over the left junction area (midpoint of mjA1 and mjB1)
            constrain op1.center_x = midpoint(mjA1, mjB1)
            constrain op1.center_y = midpoint(mjA1, mjB1)
            // op2 centered over the right junction area (midpoint of mjA2 and mjB2)
            constrain op2.center_x = midpoint(mjA2, mjB2)
            constrain op2.center_y = midpoint(mjA2, mjB2)
        }
    }

    // === MACRO LEVEL ===
    group macro {
        // Label using new [role: label] modifier
        col macro_label [role: label] {
            text "Macro" macro_lbl [font_size: 20, fill: text-1]
            text "Nodes & Lines" [font_size: 12, fill: text-2]
        }

        row graph [gap: 100] {
            circle n1 [fill: accent-1, size: 50, label: "OP 1"]
            circle n2 [fill: accent-1, size: 50, label: "OP 2"]
            n1 -- n2 [stroke: accent-1, stroke_width: 3, label: "Section of Line (SoL)", routing: direct]
        }
    }

    // Aggregation arrows with connection label references
    text "Aggregation" agg_label [font_size: 11, fill: foreground-3]
    text "Simplification" simp_label [font_size: 11, fill: foreground-3]
    micro_label -> meso_label [label: agg_label, label_position: right, stroke: foreground-3, routing: direct]
    meso_label -> macro_label [label: simp_label, label_position: right, stroke: foreground-3, routing: direct]

    // Constrain the level labels to same vertical axis
    // Containers for correct arrow routing
    constrain micro_label.center_x = meso_label.center_x
    constrain meso_label.center_x = macro_label.center_x
    // Text elements for visual alignment
    constrain micro_lbl.center_x = meso_lbl.center_x
    constrain meso_lbl.center_x = macro_lbl.center_x
}
