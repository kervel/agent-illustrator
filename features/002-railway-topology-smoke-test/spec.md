---
parent_branch: main
feature_number: "002"
status: In Progress
created_at: 2026-01-23T12:00:00+01:00
---

# Feature: Railway Topology Smoke Test Illustration

## Overview

Create the first reference DSL source document for the Agent Illustrator language. This document describes railway network topology at three abstraction levels (Micro, Meso, Macro), demonstrating hierarchical aggregation from detailed track layouts to simplified network graphs.

**Scope**: This feature covers ONLY the creation of the DSL source file. Rendering to SVG is a separate feature.

This example is ideal as a smoke test because it exercises:
- Multiple shape types (lines, circles, ovals, rectangles)
- Text labels at various positions
- Hierarchical grouping (three distinct levels)
- Connection/relationship representation (aggregation arrows)
- Semantic layout (vertical stacking with flow arrows)
- Overlapping elements (tracks passing through operational point regions)

The original image was generated by an AI agent but contains factual inaccuracies in how it represents railway topology concepts. This smoke test will produce a corrected, accurate version.

## Clarifications

### Session 2026-01-23
- Q: What specific railway topology corrections should be made? → A: Keep visual layout as-is for now; corrections deferred until system is operational
- Q: What should happen if DSL parsing or SVG rendering fails? → A: Detailed diagnostics with full error trace plus partial AST dump for debugging
- Q: Does this feature include SVG rendering? → A: No, this feature is ONLY the creation of the DSL source document; rendering is a separate feature

## Reference Image Analysis

The target illustration shows:

1. **Micro Level** (top): Detailed track geometry showing multiple parallel tracks with switches, crossovers, and junctions. Blue lines represent individual tracks.

2. **Meso Level** (middle): Two overlapping semi-transparent green circles labeled "OP1" and "OP2" (Operational Points). The same track geometry passes through these regions, showing how micro-level detail is grouped into operational points.

3. **Macro Level** (bottom): A simplified graph with two green ovals (OP1, OP2) connected by blue lines labeled "Line Section". This represents the abstract network topology.

4. **Aggregation Arrows**: Gray downward arrows between levels labeled "Aggregation" showing the transformation from detailed to abstract.

## User Scenarios

### Scenario 1: DSL Document Parses Successfully
The DSL source file is syntactically valid and parses into a correct AST without errors.

**Acceptance Criteria:**
- DSL code parses without syntax errors
- Parser produces a valid AST
- All declared shapes, connections, and layouts are represented in the AST

### Scenario 2: Hierarchical Structure is Expressed
The DSL document expresses three topology levels as nested groups with clear parent-child relationships.

**Acceptance Criteria:**
- Three top-level groups named/labeled for micro, meso, macro
- Layout directive specifies vertical arrangement
- Aggregation arrows connect adjacent levels

### Scenario 3: Track Geometry is Described
The micro-level section describes parallel tracks with switches using appropriate DSL constructs.

**Acceptance Criteria:**
- Multiple track lines declared with identifiers
- Switch/junction connections expressed
- Track grouping reflects physical layout intent

### Scenario 4: Operational Points are Defined
The meso-level section defines labeled regions that semantically group track elements.

**Acceptance Criteria:**
- OP1 and OP2 declared as named groups or regions
- Style modifiers specify semi-transparency
- Labels associated with each operational point

### Scenario 5: Macro Graph is Abstracted
The macro-level section expresses a simplified node-edge graph without micro-level detail.

**Acceptance Criteria:**
- OP1 and OP2 declared as node shapes
- Line sections declared as labeled connections
- No reference to individual track elements at this level

## Functional Requirements

### FR-1: Three-Level Vertical Layout Structure
The DSL document must express three distinct sections with vertical layout intent.

**Requirement:** The DSL must express three groups (micro, meso, macro) arranged in a vertical column layout.
**Testable Criterion:** AST contains three top-level groups with a column/vertical layout container.

### FR-2: Level Labels
Each topology level must have an associated text label.

**Requirement:** Text labels "Micro", "Meso", and "Macro" are declared and associated with their respective sections.
**Testable Criterion:** AST contains text/label nodes with these values linked to level groups.

### FR-3: Aggregation Flow Arrows
Downward arrows must be declared connecting the levels.

**Requirement:** Arrow connections with "Aggregation" labels connect Micro→Meso and Meso→Macro.
**Testable Criterion:** AST contains connection nodes with arrow style between level groups.

### FR-4: Track Geometry (Micro Level)
The micro level must declare interconnected track lines.

**Requirement:** Multiple line elements with branching/merging connections representing railway tracks.
**Testable Criterion:** AST micro-level group contains line/polyline nodes with connection relationships.

### FR-5: Operational Point Regions (Meso Level)
The meso level must declare labeled regions with style modifiers.

**Requirement:** Two region shapes labeled "OP1" and "OP2" with semi-transparent style modifiers.
**Testable Criterion:** AST meso-level group contains shape nodes with opacity style and text labels.

### FR-6: Network Graph (Macro Level)
The macro level must declare a simplified node-edge structure.

**Requirement:** Two oval/ellipse nodes (OP1, OP2) connected by labeled edges ("Line Section").
**Testable Criterion:** AST macro-level group contains shape and connection nodes with labels.

### FR-7: Style Declarations
The document must include style specifications for visual consistency.

**Requirement:**
- Tracks: Blue color style
- Operational Points: Green color with transparency
- Arrows/Labels: Gray color

**Testable Criterion:** AST nodes contain style modifier attributes for colors.

### FR-8: DSL Expressiveness
The DSL code must be readable and maintainable.

**Requirement:** The complete illustration can be expressed in under 100 lines of DSL code.
**Testable Criterion:** Source DSL file line count is less than 100.

## Success Criteria

1. **Parse Success**: The DSL document parses without errors using the Feature 001 parser
2. **AST Completeness**: All visual elements from the reference image are represented in the AST
3. **DSL Clarity**: A developer unfamiliar with the DSL can understand the illustration structure by reading the source code
4. **Compactness**: Document is under 100 lines while remaining readable
5. **Grammar Coverage**: Document exercises core grammar features: shapes, groups, connections, labels, styles, layout directives

## Key Entities

### TopologyLevel
A horizontal band representing one abstraction level (micro, meso, or macro) with its contained elements.

### Track
A line segment or polyline representing railway track geometry at the micro level.

### OperationalPoint
A named region (OP1, OP2) that groups micro-level tracks into a logical unit at the meso level.

### LineSection
An edge in the macro-level graph connecting two operational points.

### AggregationArrow
A visual connector showing the transformation relationship between adjacent topology levels.

### Label
Text annotation for levels, operational points, or line sections.

## Assumptions

1. **Feature 001 Complete**: The grammar and AST from Feature 001 are available and functional
2. **Text-based DSL**: The document is a plain text file using the Agent Illustrator grammar
3. **Left-to-Right Reading**: Labels and text flow left-to-right (Western reading order)
4. **Simplified Track Geometry**: Exact track topology is illustrative, not based on real railway data
5. **Two Operational Points**: The example uses exactly two OPs; extensibility to more is not required for this smoke test
6. **No Rendering Verification**: Visual correctness will be verified in a future rendering feature

## Edge Cases & Error Handling

### Parse Failures
If the DSL document has syntax errors during development, the parser (from Feature 001) should provide:
- Line and column number of the error location
- Clear description of what was expected vs. what was found
- Partial AST dump showing successfully parsed elements

This enables rapid iteration on the DSL document.

## Out of Scope

- SVG rendering (separate feature)
- Layout algorithm implementation (separate feature)
- Interactive features
- Real railway data import
- Railway topology accuracy corrections (deferred to future iteration)
- CLI tooling for parsing
